<?xml version="1.0" encoding="utf-8" ?>
<odoo>

    <template id="template_includes" inherit_id="website.assets_frontend" name="JIM Template Includes">

        <!-- Estilos propios del módulo (en static/less/)  -->
        <xpath expr="link[last()]" position="after">
            <!-- Importar styles.less -->
            <link href="/js_website_product/static/less/styles.less" rel="stylesheet" type="text/less"/>
        </xpath>

        <!-- Funciones JavaScript propias del módulo (en static/js/)  -->
        <xpath expr="script[last()]" position="after">
            <!-- Importar functions.js -->
            <script src="/js_website_product/static/js/functions.js" type="text/javascript" />
        </xpath>

    </template>

    <!-- Personalizar vista del producto (variantes)  -->
    <template id="custom_product_variants" name="Custom Product Variants">

        <!-- Desactivar variantes sin stock  -->
        <t t-name="custom_product_variants">
            <t t-set="attribute_value_ids" t-value="product_attributes"/>

            <ul t-attf-class="list-unstyled js_add_cart_variants #{ul_class}" t-att-data-attribute_value_ids="json.dumps(product_attributes)">
                <t t-foreach="product.attribute_line_ids.sorted(key=lambda x: x.attribute_id.sequence)" t-as="variant_id">
                    <li t-if="len(variant_id.value_ids) &gt; 1">

                        <strong t-field="variant_id.attribute_id.name"/>

                        <t t-if="variant_id.attribute_id.type == 'select'">
                            <!-- Usamos selectpicker para el select si está disponible (ya lo carga js_website_vimenpaq) -->
                            <select t-attf-class="form-control selectpicker #{'js_variant_change' if variant_id.attribute_id.create_variant else ''}" t-att-name="'attribute-%s-%s' % (product.id, variant_id.attribute_id.id)">
                                <t t-foreach="variant_id.value_ids" t-as="value_id">
                                    <option t-att-value="value_id.id" t-att-disabled="'disabled' if value_id.id not in attr_ids_with_stock else None">
                                        <span t-field="value_id.name"/>
                                        <span t-if="value_id.price_extra">
                                            <t t-esc="value_id.price_extra &gt; 0 and '+' or ''"/><span t-field="value_id.price_extra" style="white-space: nowrap;" t-options="{ &quot;widget&quot;: &quot;monetary&quot;, &quot;from_currency&quot;: product.currency_id, &quot;display_currency&quot;: website.currency_id }"/>
                                        </span>
                                    </option>
                                </t>
                            </select>
                        </t>

                        <t t-if="variant_id.attribute_id.type == 'radio'">
                            <ul class="list-unstyled">
                                <t t-set="inc" t-value="0"/>
                                <t t-foreach="variant_id.value_ids" t-as="value_id">
                                    <t t-set="inc" t-value="inc+1" t-if="value_id.id in attr_ids_with_stock or inc > 0"/>
                                    <li class="form-group js_attribute_value" style="margin: 0;">
                                        <label class="control-label" style="margin: 0 20px;">
                                            <input type="radio" t-att-class="'js_variant_change' if variant_id.attribute_id.create_variant else None" t-att-disabled="'disabled' if value_id.id not in attr_ids_with_stock else None" t-att-checked="'checked' if inc == 1 else None" t-att-name="'attribute-%s-%s' % (product.id, variant_id.attribute_id.id)" t-att-value="value_id.id" style="vertical-align: top; margin-right: 10px;"/>
                                            <span t-field="value_id.name"/>
                                            <span class="badge" t-if="value_id.price_extra">
                                                <t t-esc="value_id.price_extra &gt; 0 and '+' or ''"/><span t-field="value_id.price_extra" style="white-space: nowrap;" t-options="{ &quot;widget&quot;: &quot;monetary&quot;, &quot;from_currency&quot;: product.currency_id, &quot;display_currency&quot;: website.currency_id }"/>
                                            </span>
                                        </label>
                                    </li>
                                </t>
                            </ul>
                        </t>

                        <t t-if="variant_id.attribute_id.type == 'color'">
                            <ul class="list-inline">
                                <t t-set="inc" t-value="0"/>
                                <li t-foreach="variant_id.value_ids" t-as="value_id">
                                    <t t-set="inc" t-value="inc+1" t-if="value_id.id in attr_ids_with_stock or inc > 0"/>
                                    <label t-attf-style="background-color:#{value_id.html_color or value_id.name}" t-attf-class="css_attribute_color #{'active' if inc == 1 else ''}">
                                        <input type="radio" t-att-class="'js_variant_change' if variant_id.attribute_id.create_variant else None" t-att-disabled="'disabled' if value_id.id not in attr_ids_with_stock else None" t-att-checked="'checked' if inc == 1 else None" t-att-name="'attribute-%s-%s' % (product.id, variant_id.attribute_id.id)" t-att-value="value_id.id" t-att-title="value_id.name"/>
                                    </label>
                                </li>
                            </ul>
                        </t>

                    </li>
                </t>
            </ul>
        </t>

    </template>

    <!-- Personalizar vista del producto (variantes)  -->
    <template id="custom_product" inherit_id="website_sale.product" name="Custom Product" priority="1" >

        <xpath expr="//form/div[hasclass('js_product')]" position="replace">
            <div class="js_product" t-if="product.product_variant_ids">
                <t t-placeholder="select">
                    <input type="hidden" class="product_id" name="product_id" t-att-value="product.product_variant_id.id if len(product.product_variant_ids) == 1 else '0'"/>
                    <!-- Incluir plantilla custom_product_variants en vez de website_sale.variants -->
                    <t t-call="js_website_product.custom_product_variants">
                        <t t-set="ul_class" t-value="'nav-stacked'"/>
                    </t>
                </t>
                <t t-call="website_sale.product_price"/>
                <p t-if="len(product.product_variant_ids) &gt; 1" class="css_not_available_msg bg-warning" style="padding: 15px;">Esta combinación no está disponible.</p>
                <a id="add_to_cart" class="btn btn-primary btn-lg mt8 js_check_product a-submit" href="#">Añadir al carrito</a>
            </div>
        </xpath>

    </template>

</odoo>
